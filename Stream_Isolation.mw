{{Header}}
{{#seo:
|title=Stream Isolation
|description=Prevent Identity Correlation through Circuit Sharing by using Tor Stream Isolation.
}}
<!--
[[File:WhonixStreamIsolation.jpg|thumb|New illustrative {{project_name_long}} stream isolation image with 4 Tor relays. (Instead of 3 in the past.) See also [[vanguards]].]]
-->
<div class="mininav">
* [[Stream_Isolation/Easy|short stream isolation summary]]
* [[Stream Isolation|all information below]]
</div>
{{intro|
Prevent Identity Correlation through Circuit Sharing by using Tor Stream Isolation.
}}
<!--
[[File:Stream-isolation-promo.jpg|thumb]]
-->
[[File:Streamisolationme.jpg|thumb|Old illustrative {{project_name_short}} stream isolation image.]]

__TOC__
== Introduction ==
=== Essentials ===
* <u>No common term without Tor:</u> If the internet is used normally, without Tor, a proxy, or VPN, there is no widely used term for this. This could be coined "connecting over clearnet".
* <u>Tor Browser on the host is application-limited:</u> When using Tor without {{project_name_short}} such as when using the Tor Browser Bundle on a host operating system such as Windows or Debian, only the Tor Browser Bundle connects over Tor. All other applications are still using clearnet.
* <u>{{project_name_short}} torifies system traffic via the gateway:</u> In case of {{project_name_short}}: {{TorifiedGateway}}
* <u>Two distinct issues:</u> There are two different issues.
** <u>IP Hiding:</u> {{project_name_short}} provides [[Reliable IP Hiding]] in any case irrespective of applications (such as [[Other Browsers|browsers]], ssh, [[Remote_Administration#Remmina|Remmina]]), activities (such as [[Remote Administration]]), or protocols such as TCP, [[Tor#DNS|DNS]], [[Tor#ICMP|ICMP]], [[Tor#UDP|UDP]], RDP). Using helper utilities such as <code>torsocks</code>, <code>torify</code> or configurations such as Tor <code>SocksPort</code>s is not required for IP concealment. In context of anonymity, hiding of IP addresses is of absolutely crucial importance.
** <u>Stream Isolation:</u> Provides additional privacy protection by preventing correlation between different applications' traffic. Stream isolation aware applications; using helper utilities such as <code>torsocks</code>; and/or configurations such as Tor <code>SocksPort</code> are required. Some are already pre-configured. Compared to IP hiding, stream isolation is a detail optimization precaution but not of critical importance.

=== Transparent Proxy ===
This chapter explains what a Transparent Proxy is. It is required knowledge in order to understand the following chapters.

<u>Terminology:</u>

* <u>Meaning of transparent proxying:</u> Transparent proxying means, simplified and [[unspecific|unspecific to {{project_name_short}}]]: <blockquote>An application can connect without requiring additional configuration.</blockquote>
* <u>Clearnet Firefox on the host:</u> Use Firefox on host operating system without Tor or any proxy/VPN without {{project_name_short}} involved: It is not clear this should be called "transparent proxying". It is probably best not to call it that way to avoid confusion. In that case, the home router is likely doing "transparent proxying". A proxy that is transparent. It does things for the user/program without the user necessarily having to know anything about it.
* <u>Tor Browser on the host:</u> Using Tor Browser on the host without {{project_name_short}} involved: This is an example of "no transparent proxying available". <ref>
Tails used to have transparent proxying (could use any application without configuration). Nowadays Tails has no transparent proxying. (Most) Custom installed applications (example: Mozilla Firefox) won't connect without manual configuration in Tails.
</ref>
* <u>Other transparent proxy types exist:</u> There are also other types of transparent proxies such as content filtering, virus scanning, and so on.
* <u>{{project_name_short}} specific meaning:</u> More complex, specific to {{project_name_short}}: <blockquote>An application can use TCP/DNS [UDP blocked] over Tor (user -> Tor -> destination) without requiring additional configuration.</blockquote>

<u>{{project_name_short}} specific:</u>

* <u>Enabled by default:</u> {{project_name_short}} has the feature <code>transparent proxying</code> enabled by default. <code>transparent proxying</code> is a feature that most users want. Not enabling <code>transparent proxying</code> by default would be confusing for most users.
* <u>{{project_name_gateway_short}} acts as a Tor Transparent Proxy:</u> In other words, {{project_name_gateway_short}} by default can be used as a Tor Transparent Proxy. Connections from {{project_name_workstation_long}} to {{project_name_gateway_short}} are transparently proxied through Tor.
* <u>Example application:</u> For example if using [[Telegram]] in {{project_name_short}}: Uses transparent proxying because it is not pre-configured by default to use Tor proxy settings.

=== Identity Correlation through Tor Circuit Sharing ===
* <u>Risk from circuit sharing:</u> If the user installs custom applications and omits explicitly taking precautions against {{Code2|identity correlation through Tor circuit sharing}}, the user is risking that different activities, let's say web (Chromium or similar) or IRC ([[HexChat]] or similar) go through the same Tor circuit and Tor exit relay.
* <u>What an observer can still correlate:</u> Even though the user would still be anonymous, i.e. the Tor exit relay would still not know the user's real IP/location, the Tor exit relay (and maybe the the Tor exit relay's {{isp}}) can potentially correlate those activities from different applications to the same pseudonym.
* <u><code>SocksPort</code> vs <code>TransPort</code> behavior:</u> The following graphic illustrates the difference of using Tor <code>SocksPort</code>s compared to using Tor's <code>TransPort</code>.
** <u>Dedicated <code>SocksPort</code> per application:</u> Using a dedicated Tor <code>SocksPort</code> per application results in taking different routes through the Tor network per application.
** <u>Relay changes vary:</u> Not necessarily all Tor relays (first, second, third) get replaced. Sometimes just the first, sometimes just the second, sometimes just the third, and sometimes multiple Tor relays in the Tor circuit change.
* <u>Different circuit does not guarantee different exit:</u> Stream isolation does not necessarily result in using a different [[Tor Entry Guards|Tor Entry Guard]] or Tor exit relay. Therefore, a different Tor circuit can ''likely'' lead to using a different Tor exit relay and [[Data_Collection_Techniques#IP_Address|IP Address]], but this is not guaranteed. Related: [[Tips_on_Remaining_Anonymous#Only_Use_One_Online_Pseudonym_at_the_Same_Time|Only Use One Online Pseudonym at the Same Time]]

'''Figure:''' ''Stream Isolation Illustration''

[[File:stream_isolation.1.0.jpg|Stream Isolation Illustration]]

* <u>{{project_name_short}} protection and why technical background knowledge helps:</u> {{project_name_short}} implements protection against {{Code2|identity correlation through Tor circuit sharing}} for preinstalled applications, however, for better privacy, the user is advised to understand a bit of the technical background.
* <u>How isolation is achieved:</u> Different <code>SocksPort</code>s, <code>DnsPort</code>s, or <code>TransPort</code>s are routed through different Tor circuits, therefore preventing {{Code2|identity correlation}}.
* <u>Default application configuration:</u> {{project_name_short}} configures most applications that come preinstalled with {{project_name_short}} to use a different <code>SocksPort</code>, thus no {{Code2|identity correlation}} is at risk.
* <u>How applications are directed to different <code>SocksPort</code>s:</u> {{project_name_short}} uses either socks proxy settings to direct various applications to different <code>SocksPort</code>s or [https://github.com/{{project_name_short}}/uwt uwt] (more information below).
* <u><code>/etc/hosts</code> and stream isolation:</u> Applications configured for stream isolation (those using a <code>SocksPort</code>) ignore the <code>/etc/hosts</code> file. This includes for example [[Tor Browser]]. Therefore modifications to <code>/etc/hosts</code> for the purpose of adblocking are futile (unless using [[Tor_Browser#Tor_Browser_Transparent_Proxying|Tor Browser Transparent Proxying]]). Related: [[Tor_Browser/Advanced_Users#Tor_Browser_Filtering|Tor Browser Filtering]]
* <u><code>/etc/hosts</code> and transparent proxying:</u> Applications not configured for stream isolation, i.e. those using transparent proxying are usually honoring the <code>/etc/hosts</code> file. Select applications might have a specific implementation to ignore it depending on the application and unspecific to {{project_name_short}}.
* <u>Other traffic defaults:</u> Any other traffic (i.e. custom installed applications, misc applications, such as <code>nslookup</code>, goes through Tor's <code>DnsPort</code>, and/or <code>TransPort</code> (can be optionally disabled, see below).

== List ==
Related:

* [[Dev/Default_Application_Policy|{{project_name_short}} Default Application Policy]]
* [https://forums.whonix.org/t/should-strict-stream-isolation-by-a-requirement-in-whonixs-default-application-policy/3940 Should strict stream isolation by a requirement in Whonix's Default Application Policy?]

Applications in {{project_name_short}} that are either prepared or fully pre-configured to prevent {{Code2|identity correlation through Tor circuit sharing}}:

=== By Settings ===
{| class="wikitable"
|+ Stream Isolation - Settings Based
|-

!application
!pre-installed
!pre-configured
!stream isolation by method
!port
!comments
|-

|[[Tor Browser]]
|{{yes}}
|{{yes}}
|[[Tor_Browser/Advanced_Users#Proxy_Settings|socks proxy settings]]
|9150 <ref>{{project_name_workstation_short}} 127.0.0.1:9150 gets redirected to 10.152.152.10:9150 by [https://github.com/Whonix/anon-ws-disable-stacked-tor anon-ws-disable-stacked-tor]. Changing proxy settings in Tor Browser has proven to be unreliable. At some point Tor Button may change its internals and therefore break something again. Keeping the default settings and not requiring any changes in Tor Browser seems like the best way to support compatibility in the long run and also is simplest in case {{Code|update-torbrowser}} breaks and [[Tor_Browser/Manual_Download|manually updating Tor Browser]] is required again in future.</ref>
| -
|-

|[[E-Mail|Mozilla Thunderbird]]
|{{yes}}
|{{yes}}
|socks proxy settings
|9102
| -
|-

|Instant Messenger
|{{no}}
|{{no}}
|socks proxy settings
|port prepared, IP 10.152.152.10, port 9103
|[[Chat]]
|-

|[[sdwdate]]
|{{yes}}
|{{yes}}
|socks proxy settings
|9108
|[[Dev/TimeSync]]
|-

|[https://www.kicksecure.com/wiki/Systemcheck systemcheck]
|{{Yes}}
|{{yes}}
|socks proxy settings
| 9110
| -
|-

|Bitcoin [[electrum]] Wallet (BTC)
|{{Yes}}
|{{no}} ([https://phabricator.whonix.org/T215 TODO])
|socks proxy settings
|port prepared, IP 10.152.152.10, port 9111
| -
|-

|[[Monero]] (XMR)
|{{yes}}
|{{no}} ([[Monero#Stream_Isolation|TODO]])
|socks proxy settings
| -
| -
|-

|[[Tor_Browser#Tor_Browser_Downloader_by_{{project_name_short}}|Tor Browser Downloader by {{project_name_short}}]]
|{{yes}}
|{{yes}}
|socks proxy settings
|9115
| -
|-

|KDE application wide proxy settings
|{{no}}
|{{yes}} <ref>
* https://github.com/Whonix/anon-apps-config/blob/master/etc/profile.d/50_anon-apps-config.sh
* https://github.com/Whonix/anon-apps-config/blob/master/usr/share/anon-apps-config/kioslaverc
</ref>
|socks proxy settings
|9122 no KDE applications with network activity pre-installed
| -
|-

|}

=== By uwt wrapper ===
{| class="wikitable"
|+ Stream Isolation - uwt wrapper based
|-

!application
!pre-installed
!pre-configured
!stream isolation by method
!port
!comments
|-

|apt-get
|style="background-color:{{Green}}"|yes
|style="background-color:{{Green}}"|yes
|uwt wrapper
| -
|[[Update]]
|-

|aptitude
|style="background-color:{{Green}}"|yes
|style="background-color:{{Green}}"|yes
|uwt wrapper
| -
| -
|-

|gpg
|style="background-color:{{Green}}"|yes
|style="background-color:{{Green}}"|yes
|uwt wrapper
| -
| -
|-

|ssh
|style="background-color:{{Green}}"|yes
|style="background-color:{{Green}}"|yes
|uwt wrapper
| -
| -
|-

|git
|style="background-color:{{Red}}"|no
|style="background-color:{{Green}}"|yes
|uwt wrapper
| -
| -
|-

|wget
|style="background-color:{{Green}}"|yes
|style="background-color:{{Green}}"|yes
|uwt wrapper
| -
| -
|-

|curl
|style="background-color:{{Green}}"|yes
|style="background-color:{{Green}}"|yes
|uwt wrapper
| -
| -
|-

|scurl
|style="background-color:{{Green}}"|yes
|style="background-color:{{Green}}"|yes
|uwt wrapper
| -
|Uses curl, therefore same as curl.
|-

|}

=== none ===
{| class="wikitable"
|+ Stream Isolation - none
|-

!application
!pre-installed
!pre-configured
!stream isolation by method
!port
!instructions
|-

|GNOME application wide proxy settings
|style="background-color:{{Red}}"|no
|style="background-color:{{Red}}"|[[Dev/GNOME|no]]
|style="background-color:{{Red}}"|none
|no GNOME applications with network activity pre-installed
| -
|-

|<code>[https://www.kicksecure.com/wiki/Systemcheck systemcheck] --leak-tests</code>
|style="background-color:{{Green}}"|yes
|style="background-color:{{Red}}"|no <ref name=systemcheck-leak-tests>
<code>systemcheck --leak-tests</code> runs only on user request and never by its own by chance.

Tests two things, a Tor <code>SocksPort</code> and Tor's <code>TransPort</code>.

<code>SocksPort</code> test uses <code>SOCKS_PORT_SYSTEMCHECK</code> <code>9110</code>.

Stream isolating transparent proxying, the Tor <code>TransPort</code> leak test is impossible. The whole point of the leak test is to check if connections not configured to use a Tor <code>SocksPort</code> will be torified or not.
</ref>
|style="background-color:{{Red}}"|none
|See footnote. <ref name=systemcheck-leak-tests />
| -
|-

|}

== Details ==
* <u>How stream isolation is implemented:</u> The required socks proxy settings are set up by various {{project_name_short}} configuration packages or uwt wrappers, which are set up on {{project_name_gateway_long}} and on {{project_name_workstation_short}}.
* <u>What uwt is:</u> uwt is a wrapper around [https://gitlab.torproject.org/legacy/trac/-/wikis/doc/torsocks torsocks], which is also already installed to {{Code|/usr/bin/uwt}}.
* <u>How uwt wrappers behave by default:</u> For example, each time you run a uwt wrapped application, i.e. simply type {{Code2|apt-get}} in console, the uwt wrapper {{Code|/usr/bin/apt-get}} will run. It adds uwt before apt-get. For curiosity, check {{Code|nano /usr/bin/apt-get}}. Essentially, the uwt wrapper then runs {{Code|/usr/bin/uwt /usr/bin/apt-get.anondist-orig}}. That is also the case for all other uwt wrapped applications.
* <u>How to bypass uwt when needed:</u> If you ever want or need to run a uwt wrapped application without uwt, do not run for example {{Code|apt-get}} in console, instead run {{Code|apt-get.anondist-orig}}. Use cases could be if you want to connect to localhost. If you know what you are doing, you should also be able to deactivate any uwt wrappers you dislike, see [[#Deactivate_uwt_Stream_Isolation_Wrapper]].
* <u>What bypassing uwt changes:</u> When running {{Code2|/usr/bin/apt-get.anondist-orig}}, it directly goes through Tor's <code>DnsPort</code> and through Tor's <code>TransPort</code> and not through its own <code>SocksPort</code>.
* <u>Automatic localhost passthrough behavior:</u> uwt checks whether the command contains the words {{Code2|localhost}} or {{Code2|127.0.0.1}}. If that is the case, uwt will not be used. The command will be run without uwt. Thus, if a localhost connection is falsely detected, it will leak, but only through Tor's <code>DnsPort</code> and through Tor's <code>TransPort</code>, which should be acceptable.
* <u>Isolate by destination address:</u> Let's assume SSH goes over port 22 and you want to connect to different SSH servers and do not want an observer to be able to correlate that activity to the same pseudonym. If the SSH servers run on different IPs, isolate by destination address might help.
* <u>Isolate by destination port:</u> This doesn't seem to be useful for anything in {{project_name_short}}. Applications using different protocols (and therefore different ports) are already isolated through using different <code>SocksPort</code>s.
* <u>Why it doesn't help for web browsing:</u> Isolate by destination port doesn't really achieve anything for web browsing: [https://lists.torproject.org/pipermail/tor-talk/2012-May/024403.html tor-talk Tor's stream isolation features defaults].
* <u>Where to learn more:</u> For more information about stream isolation refer to the Tor manual.
** <u>Stable manual:</u> [https://2019.www.torproject.org/docs/tor-manual.html.en Tor stable manual]
** <u>Alpha manual:</u> [https://2019.www.torproject.org/docs/tor-manual-dev.html.en Tor alpha manual]

=== Tor Browser ===
* <u>Domain-based SOCKS authentication:</u> Tor Browser has a feature [https://gitlab.torproject.org/legacy/trac/-/issues/3455 Tor Browser should set SOCKS username for a request based on first party domain]. Tor Browser makes use of Tor's [[Stream_Isolation#IsolateSOCKSAuth|<code>IsolateSOCKSAuth</code>]] option. {{project_name_short}} does not break this feature. <ref>
This feature does not even require Tor <code>ControlPort</code> access. All that Tor Browser requires from {{project_name_short}} is being able to connect to a Tor <code>SocksPort</code>.
</ref>
* <u>Note about a previous claim:</u> This wiki page stated <s>Different tabs and websites in Tor Browser are isolated by Tor Browser. <ref>
https://gitlab.torproject.org/legacy/trac/-/issues/3455
</ref></s>. This was either always incorrect or Tor Browser's behavior has changed meanwhile.

{{quotation|
quote='''Tor circuit and HTTP connection linkability'''

'''Design Goal:''' Tor circuits and HTTP connections from a third party in one URL bar origin MUST NOT be reused for that same third party in another URL bar origin.

'''Implementation Status:''' The isolation functionality is provided by a Torbutton component that [https://gitweb.torproject.org/torbutton.git/tree/src/components/domain-isolator.js sets the SOCKS username and password for each request]. The Tor client has logic to prevent connections with different SOCKS usernames and passwords from using the same Tor circuit. Firefox has existing logic to ensure that connections with SOCKS proxies do not re-use existing HTTP Keep-Alive connections unless the proxy settings match. [https://bugzilla.mozilla.org/show_bug.cgi?id=1200802 We extended this logic] to cover SOCKS username and password authentication, providing us with HTTP Keep-Alive unlinkability.
While the vast majority of web requests adheres to the circuit and connection unlinkability requirement there are still corner cases we [https://gitweb.torproject.org/tor-browser.git/commit/?h=tor-browser-52.5.2esr-7.0-2&id=8661822237c56d543d5c9117c8a4708c402a110f need to treat separately] or that [https://bugs.torproject.org/22343 lack a fix altogether].
|context=upstream, The Tor Project: [https://www.torproject.org/projects/torbrowser/design/ The Design and Implementation of the Tor Browser (DRAFT)]
}}

* <u>Upstream is the source of truth:</u> Tor Browser is developed by upstream, [https://www.torproject.org The Tor Project], which is an independent entity. For up-to-date information, refer to upstream, Tor Browser.
* <u>Related forum discussion:</u> https://forums.whonix.org/t/tor-browser-new-identity-differs-from-restarting-tor-browser-in-whonix/3098/4

=== Onion Services ===
* <u>Automatic isolation for different onion services:</u> Connections to different Tor [[Onion Services]] are automatically stream isolated. <ref>
https://lists.torproject.org/pipermail/tor-talk/2012-September/025432.html
</ref>

== How to mitigate identity correlation ==
=== Basic Protection ===
* <u>Manually configure custom applications:</u> If you install custom software on {{project_name_workstation_short}} that uses the internet, and you want to prevent {{Code2|identity correlation through Tor circuit sharing}} (which you should do), you have to manually configure it. This is not a {{project_name_short}} specific problem. <ref>
If you used to use only one <code>SocksPort</code> with the [https://gitlab.torproject.org/legacy/trac/-/wikis/doc/TorifyHOWTO common torification methods], the [https://lists.torproject.org/pipermail/tor-talk/2012-March/023535.html same thing happened].
</ref> Read also [[Install Software|Software installation on {{project_name_workstation_short}}]].
* <u>Use the pre-configured list where possible:</u> A [[#list]] of applications that come pre-installed with {{project_name_short}} are pre-configured to prevent {{Code2|identity correlation through circuit sharing}}.
* <u>Be aware of <code>TransPort</code> pollution during tests:</u> Traffic going through <code>TransPort</code> by default includes [https://www.kicksecure.com/wiki/Systemcheck systemcheck] when manually testing the <code>TransPort</code> by using <code>systemcheck --leak-tests</code>. If that is of concern to you, see the following bullets.
* <u>Optionally adjust systemcheck behavior:</u> It can be disabled in systemcheck, see [https://www.kicksecure.com/wiki/Systemcheck_Hardening#Prevent_Polluting_TransPort prevent polluting <code>TransPort</code>], but that might make little sense.
* <u>Prefer to avoid the test instead:</u> Better to avoid the test instead.
* <u>Understand the default routing:</u> All custom installed applications' TCP traffic is routed through Tor's <code>TransPort</code> and all their DNS requests through Tor's <code>DnsPort</code>. This means different activities or "identities" in different applications (say browser, IRC, email) end up being routed through the same Tor circuit, thus {{Code2|identity correlation}} is at risk. <ref>
What about UDP? See [[Tor#UDP]].
</ref>
* <u>Use a dedicated <code>SocksPort</code> per custom application:</u> To protect against this, you have to set up and configure applications to use a dedicated Tor <code>SocksPort</code>. Each custom installed application has to be directed to a dedicated Tor <code>SocksPort</code>. For instructions how to do that, use the [https://gitlab.torproject.org/legacy/trac/-/wikis/doc/TorifyHOWTO Torify HOWTO]. Generally, this can be done either by configuring the application's proxy settings or by using a proxifier (socksifier) such as <code>torsocks</code>.
* <u>Multiple Workstations are automatically separated:</u> [[Multiple Whonix-Workstation|Multiple {{project_name_workstation_short}}]] are automatically stream isolated. <ref name=multiple-workstation />
* <u>No universal best method exists:</u> What is better, configure the application's proxy settings or use a proxifier? There can be no generalized answer as this is highly application specific. The most comprehensive documentation of this is the Torify HOWTO. Also, a web search can be performed on how to torify applications.
* <u>This adds stream isolation on top of torification:</u> Applications inside {{project_name_short}} are already torified but by applying these instructions inside {{project_name_short}} the user would go one step further, i.e. add stream isolation.
* <u>Up to date torification instructions are difficult to maintain:</u> Finding up to date instructions for torification is difficult because developing instructions for torification itself is a difficult process. Someone who understands networking needs to leak test whether the torification instructions are actually working. A leak would mean that portions of the application's traffic ignore proxy settings and/or circumvent the proxifier and are actually making external connections without using Tor. Such leaks would be much less severe in {{project_name_short}}. It would only result in {{Code2|identity correlation through Tor circuit sharing}} but not in a leak of the user's real IP address to the destination.
* <u>Support requests are usually ineffective:</u> Asking for torification instructions for specific applications at {{project_name_short}} [[Support|Free Support]] is probably futile. The {{project_name_short}} is the wrong recipient for such support requests. One of the main reasons for the inception of the {{project_name_short}} was that finding, developing and applying torification instructions is so difficult and one never really knows if it is 100% free of leaks. Even seriously reviewed torification instructions for one application would only apply to the exact version that was being reviewed. Not to future versions of the application.
* <u>The legacy approach is less actively maintained:</u> The legacy approach of torification of arbitrary applications on the host seems to have been largely given up. There are very few edits to the Torify HOWTO over the years. Nowadays some application developers are providing Tor-safe by default applications, i.e. applications designed for use with Tor in mind and not as an afterthought. Examples include [[Tor Browser]] and [[OnionShare]]. Also if users are asking how to torify specific applications and making sure these are leak free, users are probably told "use Whonix".
* <u>Honor protocol warnings:</u> Protocol related warnings that you must honor still apply. You are still better off with {{project_name_short}}, as it offers best possible [[Protocol-Leak-Protection and Fingerprinting-Protection]].
* <u>IP leak protection still applies:</u> {{project_name_short}} setup provides protection against IP leaks through [https://gitlab.torproject.org/legacy/trac/-/wikis/doc/TorifyHOWTO#protocol-leaks protocol leaks].
* <u>Misconfiguration has predictable outcomes:</u> If you do not correctly torify, either no connections will be possible or traffic will continue going through Tor's <code>TransPort</code> unless you [[#Better Protection|disable transparent torification]].
* <u>Do not share a <code>SocksPort</code> across applications:</u> If you redirect more than one application to the same <code>SocksPort</code>, {{Code2|identity correlation}} is at risk.
* <u>DNS warnings still matter:</u> DNS related [https://gitlab.torproject.org/legacy/trac/-/wikis/doc/TorFAQ#i-keep-seeing-these-warnings-about-socks-and-dns-and-information-leaks-should-i-worry warnings] still apply, though to a lesser extent. An attack could only make correlations but still could not figure out your IP. To prevent that, see chapter [[#Better Protection|better protection]].
* <u>Avoid local DNS resolvers:</u> Do not use a [https://gitlab.torproject.org/legacy/trac/-/wikis/doc/SupportPrograms#dns-resolvers local DNS resolver], as all DNS requests would be executed by the same Tor circuit.
* <u>Some leak classes do not apply here:</u> Other leaks, such as applications not honoring the proxy settings / wrapper, ICMP or UDP leaks do not apply to {{project_name_short}}.
* <u><code>SafeSocks</code> is optional:</u> The SafeSocks setting is for rejecting unsafe variants of socks that might cause DNS leaks. The {{project_name_short}} design model mitigates DNS leaks by redirecting all requests to Tor's <code>DnsPort</code>. Enabling this setting would give marginal benefit in this situation but would complicate debugging.
* <u>Pre-prepared custom socks ports exist:</u> On {{project_name_gateway_short}} there are already a lot of custom socks ports prepared for use with custom installed applications. <ref>
Tor configuration file <code>/etc/torrc.d/70_workstation.conf</code> <code>%include</code>s file <code>/usr/share/tor/tor-service-defaults-torrc.anondist</code>.
</ref>
* <u>Default range without isolation flags:</u> Without {{Code2|IsolateDestAddr}} and without {{Code2|IsolateDestPort}}: <code>SocksPort</code> <code>9153</code> to <code>9159</code>
* <u>Range with destination address isolation:</u> With {{Code2|IsolateDestAddr}}, but without {{Code2|IsolateDestPort}}: <code>SocksPort</code> <code>9160</code> to <code>9169</code>
* <u>Range with destination port isolation:</u> Without {{Code2|IsolateDestAddr}}, but with {{Code2|IsolateDestPort}}: <code>SocksPort</code>: <code>9170</code> to <code>9179</code>
* <u>Range with both isolation flags:</u> With {{Code2|IsolateDestAddr}} and with {{Code2|IsolateDestPort}}: <code>SocksPort</code>: <code>9180</code> to <code>9189</code>
* <u>Add more if needed:</u> If those are not enough, you can add your own.
* <u>Isolation flags are usually unnecessary:</u> What are {{Code2|IsolateDestAddr}} and {{Code2|IsolateDestPort}}? You can learn about them in the [https://2019.www.torproject.org/docs/tor-manual.html.en Tor manual]. See also [https://lists.torproject.org/pipermail/tor-talk/2012-May/024403.html tor-talk mailing list: Tor's stream isolation features defaults]. Usually, unless you know better, you are better off not using {{Code2|IsolateDestAddr}} or {{Code2|IsolateDestPort}}.

{{Box|text=
'''Generic instructions for configuring custom installed applications for stream isolation for less than 7 custom applications'''

# [[Install Software|Install]] custom application.
# Configure application to use a dedicated Tor <code>SocksPort</code> according to [https://gitlab.torproject.org/legacy/trac/-/wikis/doc/TorifyHOWTO Torify HOWTO] by either configuring the application's proxy settings or by using a proxifier such as <code>torsocks</code>.
# Start custom application.
}}

{{Box|text=
'''Generic instructions for configuring custom installed applications for stream isolation using proxifier (socksifier) <code>torsocks</code>'''

# [[Install Software|Install]] custom application.
# {{Open a product ws terminal}}
3. Start custom application from the command line by prepending <code>torsocks</code>.

{{CodeSelect|code=
torsocks application-name
}}

Using this method, there is no need to specify any proxy IP address, port number, protocol. <ref>
This is because <code>torsocks</code> configuration file [https://github.com/{{project_name_short}}/uwt/blob/master/etc/tor/torsocks.conf.anondist <code>/etc/tor/torsocks.conf.anondist</code>] is preconfigured with setting <code>IsolatePID 1</code>.

<pre>
# Set Torsocks to use an automatically generated SOCKS5 username/password based
# on the process ID and current time, that makes the connections to Tor use a
# different circuit from other existing streams in Tor on a per-process basis.
# If set, the SOCKS5Username and SOCKS5Password options must not be set.
# (Default: 0)
IsolatePID 1
</pre>
</ref>
}}

{{Box|text=
'''Generic instructions for configuring custom installed applications for stream isolation for less than 7 custom applications using the application's proxy settings'''

# [[Install Software|Install]] custom application.
# Configure application to use a dedicated Tor <code>SocksPort</code> according to [https://gitlab.torproject.org/legacy/trac/-/wikis/doc/TorifyHOWTO Torify HOWTO] by either configuring the application's proxy settings.
# protocol: socks 5
# Platform specific. Proxy IP: '''A)''' <u>[[Non-Qubes-Whonix]]</u> {{CodeSelect|code=10.152.152.10}} '''B)''' <u>Qubes-Whonix:</u> Use the IP address returned by running the following command (NOTE: do not use the command itself): {{CodeSelect|code=qubesdb-read /qubes-gateway}}
# port: {{CodeSelect|code=9153}} (use a different port according to list above if using multiple custom installed applications)
# Start custom application.

Better generic instructions for this cannot be provided since this is application specific as mentioned above.
}}

=== Better Protection ===
For best protection against {{Code2|identity correlation}}:

* <u>Follow existing guidance:</u> Read the advice above and on {{project_name_gateway_short}}.
* <u>Disable desktop-wide proxy settings:</u> Deactivate KDE / GNOME - application wide proxy settings because those proxy settings are not application specific, but rather force all KDE / GNOME applications through the same <code>SocksPort</code>. There are no KDE / GNOME applications which use the internet preinstalled by default. However, deactivating those KDE / GNOME wide proxy settings gives finer control over stream isolation.
* <u>Disable transparent proxying:</u> Disable transparent proxying as documented below.

=== Best Protection ===
Best stream isolation is only possible if you honor the advice above and only use one application per session and always revert to a fresh image or [[Multiple Whonix-Workstation|Multiple {{project_name_workstation_short}}]]. <ref name=multiple-workstation>
[[Multiple Whonix-Workstation|Multiple {{project_name_workstation_short}}]] using different internal IP's are automatically separated by Tor (<code>IsolateClientAddr</code> is Tor's default).
</ref>

=== Disable Transparent Proxying ===
To deactivate transparent proxying, apply the following instructions.

Following these steps will disable the {{project_name_gateway_short}} [[#Transparent Proxy|transparent proxying]] feature and transform {{project_name_gateway_short}} into an [https://gitlab.torproject.org/legacy/trac/-/wikis/doc/TorifyHOWTO/IsolatingProxy IsolatingProxy].

'''Note:''' The following instructions should be applied in {{project_name_gateway_short}} ([[Qubes|{{q_project_name_long}}]]: In App Qubes <code>{{project_name_gateway_vm}}</code>).

'''1.''' {{Firewall_Settings}}

'''2.''' Add.

{{CodeSelect|code=
WORKSTATION_TRANSPARENT_TCP=0
WORKSTATION_TRANSPARENT_DNS=0
}}

'''3.''' Save.

'''4.''' {{Reload_Firewall}}

<ref>
Although not strictly required, you could alternatively/additionally deactivate Tor <code>TransPort</code> and <code>DnsPort</code>.

Add to {{Code2|/usr/local/etc/torrc.d/50_user.conf}}.

{{Open /usr/local/etc/torrc.d/50_user.conf}}

Add.

{{CodeSelect|code=
TransPort 0
DnsPort 0
}}

Save.

And then {{Reload_Tor}}
</ref>

'''5.''' Done.

Deactivating transparent proxying is complete.

This will disable transparent proxying. All applications not configured to use a <code>SocksPort</code> by socks proxy settings or forced to use a <code>SocksPort</code> by a socksifier will not be able to establish connections. This is the only way to ensure that different <code>SocksPort</code>s are used and also that DNS is remotely resolved through that <code>SocksPort</code>.

'''6.''' Test.

Optional.

* [[#Check if Transparent DNS is disabled|Check if Transparent DNS is disabled]]
* [[#Check if Transparent TCP is disabled|Check if Transparent TCP is disabled]]

=== IsolateSOCKSAuth ===
See [https://2019.www.torproject.org/docs/tor-manual.html.en Tor manual] <code>IsolateSOCKSAuth</code>.

<blockquote>Donâ€™t share circuits with streams for which different SOCKS authentication was provided. [...]</blockquote>

This can be used with the <code>SocksPort</code> option.

<blockquote>SocksPort [address:]port|unix:path|auto [flags] [isolation flags]</blockquote>

<code>IsolateSOCKSAuth</code> is a sub option of the <code>SocksPort</code> option.

== Qubes Specific ==
=== Qubes UpdatesProxy Stream Isolation ===
This chapter is for advanced users only.

Platform specific:

* <u>Non-Qubes-Whonix:</u> <code>apt-get</code> is stream isolated by uwt and redirected to Tor <code>SocksPort</code>. (See [[Dev/anon-ws-disable-stacked-tor|anon-ws-disable-stacked-tor]]) Therefore, every VM is using a different stream, thanks to Tor's default <code>IsolateClientAddr</code> option, which results in different IP source addresses (different internal network VM IPs) getting stream isolated.
* <u>Qubes-Whonix:</u> Security and stream isolation are unfortunately conflicting goals. Templates in Qubes are non-networked by default for better security because they don't have a network stack, hence a lower attack surface. <code>apt-get</code> is redirected without a network through Qubes qrexec to Whonix-Gateway localhost where Qubes tinyproxy is listening. Therefore, the information of the internal source IP address of the VM is "lost in translation" and does not reach Tor on Whonix-Gateway. Hence, there is no benefit from <code>IsolateClientAddr</code>. [https://github.com/QubesOS/qubes-issues/issues/8398 tinyproxy on Whonix-Gateway has been configured to use a dedicated Tor <code>SocksPort</code>]. That, of course, does not result in <code>IsolateClientAddr</code>. But at least traffic by tinyproxy is not mixed into Tor's <code>TransPort</code> / <code>DnsPort</code>. Unfortunately, all Templates using <code>sys-whonix</code> as UpdatesProxy are mixed into the same stream. In conclusion, stream isolation of <code>apt-get</code> in Qubes-Whonix is a bit worse than stream isolation in Non-Qubes-Whonix. This situation is unlikely to change due to the technical difficulty of improving it unless [[Reporting_Bugs#Contributions|contributed]]. There are no known steps that users could take to improve this situation.
** Qubes tinyproxy vs apt-cacher-ng?
*** tinyproxy: Good, can at least use a Tor <code>SocksPort</code>.
*** apt-cacher-ng: [[Unsupported]]. Unknown if it can use <code>SocksPort</code>. It might support an HTTP proxy, so maybe a Tor <code>HTTPTunnelPort</code> could be used. <ref>
https://forums.whonix.org/t/tor-can-now-serve-as-http-proxy-httptunnelport/5373
</ref>
** Qubes-Whonix related:
*** [https://github.com/QubesOS/qubes-issues/issues/7737 remove tinyproxy from Whonix-Gateway (<code>sys-whonix</code>) and make Whonix Templates networked by default with Net qube set to <code>sys-whonix</code>]
*** [[Qubes/UpdatesProxy|Qubes-Whonix UpdatesProxy user documentation]]
*** [[Dev/Qubes#Torified_UpdatesProxy|Torified UpdatesProxy developer documentation]]
** Future: Maybe in the future, after/if [https://github.com/QubesOS/qubes-issues/issues/9294 Create <code>sys-ops-whonix</code> VM for Enhanced Security and Isolation in Qubes-Whonix] gets implemented, <code>sys-ops-whonix</code> could start a new instance of Qubes UpdatesProxy each time it receives a new connection from Qubes qrexec.

== Deactivate Stream Isolation ==
=== Easy ===
Choose an option. Either '''A)''' or '''B)'''.

* '''A)''' [[Stream_Isolation/Disable_Easy|How to disable stream isolation. The easiest and most common methods only.]] Or,
* '''B)''' For more options, see below.

=== Deactivate uwt Stream Isolation Wrapper ===
'''OPTIONAL. Usually not required. Only for special setups and people who know what they are doing.'''

==== Temporary ====
===== anondist-orig Method =====
Append {{Code2|.anondist-orig}} to the command you want to run. For example, instead of using.

{{CodeSelect|code=
curl 38.229.72.22
}}

Use.

{{CodeSelect|code=
curl.anondist-orig 38.229.72.22
}}

===== Environment Variable Method =====
Use the {{Code2|UWT_DEV_PASSTHROUGH}} environment variable. <ref>https://github.com/{{project_name_short}}/uwt/blob/master/usr/libexec/uwt/uwtwrapper#L194</ref>

Example. Set the UWT_DEV_PASSTHROUGH environment variable. This will disable using <code>torsocks</code> for all subsequent invocations.

{{CodeSelect|code=
export UWT_DEV_PASSTHROUGH="1"
}}
{{CodeSelect|code=
curl 38.229.72.22
}}

When running as user and using <code>sudo</code>, do not forget the <code>sudo</code> parameter <code>-E</code> which stands for preserve environment.

{{CodeSelect|code=
sudo -E apt update
}}

==== Permanently ====
===== Introduction =====
You can enable/disable all uwt stream isolation wrappers globally or enable/disable specific stream isolation wrappers, see uwt <code>/etc/uwt.d/30_uwt_default.conf</code> configuration file.

===== deactivate all uwt wrappers permanently =====
{{Uwt_wrappers_deactivate_all_permanently}}

=== Deactivate Misc Proxy Settings ===
{{Deactivate_Misc_Proxy_Settings}}

=== Tor Browser Remove Proxy Settings ===
If you would like to remove proxy settings from Tor Browser, see below.
{{Tor_Browser_Remove_Proxy_Settings}}

== Nested Execution ==
uwt version <code>4.0-1</code> and above protects from endless nested execution which could likely lead to a locked up session by aborting after 10 times an uwt wrapped application calling another uwt wrapped application. In that case, you would see the following error message.

<blockquote>
uwtwrapper uwt wrapper ERROR: More than uwtwrapper_counter 10 nested executions (uwtwrapper_max: 10).
</blockquote>

This is most likely happening due to two symlinks pointing to each other, resulting in endless execution. However, should there be any cases (none could be foreseen at development time) where this is legitimate, feel free to change the setting responsible for aborting execution. Please also consider reporting your use case in {{project_name_short}} forums so perhaps a better fix for this can be found.

{{Open with root rights|filename=
/etc/uwt.d/50_user.conf
}}

Set <code>uwtwrapper_max</code> to a value more suitable for you.

{{CodeSelect|code=
uwtwrapper_max=100
}}

Alternatively you could completely disable the nested execution protection.

{{CodeSelect|code=
nested_protection() {
    true
}
}}

Save and exit.

Done.

== Development ==
=== Information ===
See also the [https://2019.www.torproject.org/docs/tor-manual.html.en Tor manual] on <code>SocksPort</code>, <code>HTTPTunnelPort</code>, <code>TransPort</code> and <code>DnsPort</code>.

==== SocksPort ====
A <code>SocksPort</code> is a listen port by Tor which accepts traffic using the [https://en.wikipedia.org/wiki/SOCKS socks] protocol.

Using a <code>SocksPort</code> is possible by using either:

* [https://gitlab.torproject.org/legacy/trac/-/wikis/doc/TorifyHOWTO#Classicalcommonway:usetheapplicationsproxysettings application specific socks proxy settings]
* [https://gitlab.torproject.org/legacy/trac/-/wikis/doc/TorifyHOWTO#classical-common-way-use-the-applications-proxy-settings wrapper method] such as <code>torsocks</code> (which can be automatically prepended using [https://github.com/{{project_name_short}}/uwt <code>uwt</code>])

Traffic on separate <code>SocksPort</code>s is stream isolated by Tor by default.

==== HTTPTunnelPort ====
A <code>HTTPTunnelPort</code> is a listen port by Tor which accepts traffic using the [https://en.wikipedia.org/wiki/HTTP_tunnel HTTP CONNECT method].

This is a new feature of Tor.

Traffic on separate <code>HTTPTunnelPort</code>s is stream isolated by Tor by default.

Forum discussion:<br />
https://forums.whonix.org/t/tor-can-now-serve-as-http-proxy-httptunnelport/5373

==== TransPort ====
<code>TransPort</code> is a feature where Tor accepts raw traffic on a listen port if redirected there using iptables. See also [https://gitlab.torproject.org/legacy/trac/-/wikis/doc/TransparentProxy TransparentProxy].

When using Transparent Proxying (default in {{project_name_short}}), all applications that do not use a <code>SocksPort</code> or <code>HTTPTunnelPort</code> will fall back to using Tor's <code>TransPort</code> for TCP. I.e. using system default networking. This is also called transparent proxying.

There is no stream isolation for <code>TransPort</code> connections unless originating from a [[Multiple Whonix-Workstation|separate {{project_name_workstation_short}}]]. <ref name=multiple-workstation/>

==== DnsPort ====
Similar to above but for DNS. All applications that do not use a <code>SocksPort</code> or <code>HTTPTunnelPort</code> will fall back to using Tor's <code>DnsPort</code> for DNS.

==== torsocks ====
All [[Stream_Isolation#By_uwt_wrapper|uwt wrapped applications]] will be stream isolated by [https://github.com/{{project_name_short}}/uwt/blob/master/etc/tor/torsocks.conf.anondist <code>torsocks</code>] <code>/etc/tor/torsocks.conf</code> setting <code>IsolatePID 1</code>.

To test this, run the following command multiple times.

<pre>
scurl https://check.torproject.org | grep IP
</pre>

=== Tests ===
1. Applications which internally use curl.

{{CodeSelect|code=
sudo update-command-not-found
}}
{{CodeSelect|code=
sudo update-flashplugin-nonfree --install --verbose
}}

2. Applications which are uwt wrapped themselves and internally use ssh.

{{CodeSelect|code=
git push origin master
}}

3. Enigmail.

=== Debugging / List of all uwt wrappers ===
{{CodeSelect|code=
sudo dpkg-divert --list
}}
{{CodeSelect|code=
ls -la /usr/bin/ssh
}}

=== Deactivating an uwt wrapper ===
Example:

{{CodeSelect|code=
sudo unlink /usr/bin/ssh
}}
{{CodeSelect|code=
sudo dpkg-divert --rename --remove /usr/bin/ssh
}}

=== Check if Transparent DNS is disabled ===
'''Note:''' The following test should be performed in {{project_name_workstation_short}} ([[Qubes|{{q_project_name_short}}]]: App Qube <code>{{project_name_workstation_vm}}</code>).

Test.

{{CodeSelect|code=
nslookup check.torproject.org ; echo $?
}}

Expected output.

<pre>
;; connection timed out; no servers could be reached

1
</pre>

If it shows something else, such as a resolved IP, then Transparent DNS is enabled.

=== Check if Transparent TCP is disabled ===
'''Note:''' The following test should be performed in {{project_name_workstation_short}} ([[Qubes|{{q_project_name_short}}]]: App Qube <code>{{project_name_workstation_vm}}</code>).

Test.

{{CodeSelect|code=
{{Curl_Plain}} {{Check.torproject.org IP}} ; echo $?
}}

Expected output.

<pre>
curl: (7) couldn't connect to host
7
</pre>

If it shows something else, such as the html source code, then Transparent TCP is enabled.

=== Check if Transparent Proxying is disabled ===
'''Note:''' The following test should be performed in {{project_name_workstation_short}} ([[Qubes|{{q_project_name_short}}]]: App Qube <code>{{project_name_workstation_vm}}</code>).

Test.

{{CodeSelect|code=
{{Curl_Plain}} https://check.torproject.org/ ; echo $?
}}

Expected output.

<pre>
curl: (6) Couldn't resolve host 'check.torproject.org'
6
</pre>

If it shows something else, such as the html source code, then Transparent Proxying is enabled.

=== Check if an Application is properly using Stream Isolation ===
* Same as <code>leak testing</code> as if {{project_name_short}} is not involved.
* Also... A weaker test... The <code>transparent proxying disablement</code> test.

Disable transparent proxying of DNS and TCP as per [[#Better Protection]].

Check that worked as per:

* [[#Check if Transparent DNS is disabled|Check if Transparent DNS is disabled]]
* [[#Check if Transparent TCP is disabled|Check if Transparent TCP is disabled]]

That is because it doesn't work without transparent proxying (system default networking), meaning if the application is unable to use the network normally, then there is a certain socks leak, meaning certainly some traffic which requires system default networking. In case of:

* clearnet operating systems: a clearnet leak
* {{project_name_short}}: a stream isolation violation

This is only a weak test since an application could very likely try socks first and, if socks fails, fall back to system default networking. Therefore, normal <code>leak testing</code> is required.

* Internet research if application was specifically designed for use with Tor.
* Internet research if application was specifically audited for clearnet leaks.
* Discussion with software contributor about this if these haven't already happened.
* https://gitlab.torproject.org/legacy/trac/-/wikis/doc/TorifyHOWTO#Howtoreviewanapplication
* https://lists.torproject.org/pipermail/tor-talk/2012-April/024010.html
* https://gitlab.torproject.org/legacy/trac/-/issues/5553
* [https://github.com/rustybird/corridor corridor - Tor traffic whitelisting gateway]

=== Add new uwt wrapper ===
Emulate [https://github.com/{{project_name_short}}/uwt/commit/03cc4c8568564d5993fcc8ea975cf00e851f7052 this commit].

== Sources ==

* [https://gitweb.torproject.org/torspec.git/blob/HEAD:/proposals/171-separate-streams.txt Separate streams across circuits by connection metadata]
* [https://lists.torproject.org/pipermail/tor-talk/2012-March/023496.html tor-talk Operating system updates / software installation behind Tor Transparent Proxy]
* [https://lists.torproject.org/pipermail/tor-talk/2012-March/023536.html tor-talk Awareness for identity correlation through circuit sharing is almost zero.]
* [https://lists.torproject.org/pipermail/tor-talk/2012-May/024401.html tor-talk Tor's stream isolation features defaults Question]
* [https://lists.torproject.org/pipermail/tor-talk/2012-May/024403.html tor-talk Tor's stream isolation features defaults Answer]
* [https://web.archive.org/web/20141005211329/https://mailman.boum.org/pipermail/tails-dev/2012-August/001422.html Tails-dev separate Tor streams]
* [https://tails.boum.org/todo/separate_Tor_streams/ Tails separate Tor streams]
* [https://web.archive.org/web/20160629092058/https://mailman.boum.org/pipermail/tails-dev/2012-August/001532.html Tails-dev Please review Tails stream isolation plans]
* [https://tails.boum.org/contribute/design/stream_isolation/ Tails Design: Tor stream isolation]

Stream Isolation Graphic was contributed by: Cuan Knaggs, graphic and web design. [https://web.archive.org/web/20160313102442/http://revolver.za.net/ revolver] print media, web design, web development, CMS, e-commerce

== References ==
{{reflist|close=1}}

{{Footer}}

[[Category:Documentation]] [[Category:Design]]